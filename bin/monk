#!/usr/bin/env bash
set -e

# Monk CLI - Bashly-powered command-line interface for PaaS Backend API
# 
# This wrapper ensures the bashly CLI runs with bash 4.2+ and proper environment

# Get the directory of this script (CLI root) - handle symlinks
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Resolve symlinks to get the real path
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR=$(cd "$(dirname "$SCRIPT_PATH")" && pwd)
    SCRIPT_PATH=$(readlink "$SCRIPT_PATH")
    # Handle relative symlinks (portable check)
    case "$SCRIPT_PATH" in
        /*) ;; # Absolute path, do nothing
        *) SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH" ;;
    esac
done
CLI_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"

# Change to project root directory 
cd "$CLI_ROOT"

# Check bash version requirement
if ((BASH_VERSINFO[0] < 4 || (BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] < 2))); then
    printf "bash version 4.2 or higher is required\n" >&2
    printf "You are running: $BASH_VERSION\n" >&2
    printf "Install newer bash (macOS: brew install bash, Ubuntu: bash usually recent enough)\n" >&2
    printf "Then ensure newer bash is in your PATH or use explicit path\n" >&2
    exit 1
fi

# Initialize rbenv if available (for bashly dependencies during development)
if command -v rbenv >/dev/null 2>&1; then
    eval "$(rbenv init - 2>/dev/null)" || true
fi

# Execute the bashly CLI
exec "${CLI_ROOT}/cli/monk" "$@"